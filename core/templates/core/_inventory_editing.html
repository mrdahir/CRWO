{% load static %}
<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProductForm">
                {% csrf_token %}
                <input type="hidden" id="editProductId" name="product_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Product Name <span class="text-danger">*</span></label>
                        <input type="text" id="editProductName" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Purchase Price</label>
                        <input type="number" id="editPurchasePrice" name="purchase_price" class="form-control"
                            step="0.01" min="0">
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Price (USD)</label>
                            <input type="number" id="editPriceUSD" name="selling_price_usd" class="form-control"
                                step="0.01" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Price (SOS)</label>
                            <input type="number" id="editPriceSOS" name="selling_price_sos" class="form-control"
                                step="1" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Price (ETB)</label>
                            <input type="number" id="editPriceETB" name="selling_price_etb" class="form-control"
                                step="0.01" min="0">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitEdit()">
                        <i class="fas fa-save me-2"></i>Update Product
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deleteProductId">
                <p class="mb-0">Are you sure you want to delete <strong id="deleteProductName"></strong>?</p>
                <div class="alert alert-warning mt-3 mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    This action cannot be undone. Products that have been used in sales cannot be deleted.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitDelete()">
                    <i class="fas fa-trash me-2"></i>Delete Product
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Inventory Editing Enhancement
    (function () {
        'use strict';

        const isSuperuser = {% if request.user.is_superuser %}true{% else %} false{% endif %};

    // Override displayProducts
    const originalDisplayProducts = window.displayProducts;
    window.displayProducts = function (products) {
        const container = document.getElementById('productResults');

        if (!products || products.length === 0) {
            container.innerHTML = '<div class="text-muted text-center py-5">No products found</div>';
            return;
        }

        container.innerHTML = products.map(product => `
        <div class="card mb-2">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="fw-bold">${product.name}</div>
                        <div class="text-muted small">${product.brand} â€¢ ${product.category}</div>
                        <div class="mt-1">
                            <span class="badge ${product.current_stock <= product.low_stock_threshold ? 'bg-danger' : 'bg-success'}">
                                Stock: ${product.current_stock}
                            </span>
                            ${product.current_stock <= product.low_stock_threshold ?
                `<span class="badge bg-warning ms-1">Low Stock</span>` : ''}
                        </div>
                        <div class="text-muted small mt-1">
                            USD: $${product.selling_price_usd} | SOS: ${product.selling_price_sos} | ETB: ${product.selling_price_etb}
                        </div>
                    </div>
                    <div class="d-flex flex-column gap-1">
                        <button type="button" class="btn btn-sm btn-primary" 
                                onclick="openRestockModal(${product.id}, '${product.name.replace(/'/g, "\\'")}', ${product.current_stock})">
                            <i class="fas fa-plus"></i> Restock
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                onclick="openEditModal(${product.id}, '${product.name.replace(/'/g, "\\'")}', ${product.purchase_price}, ${product.selling_price_usd}, ${product.selling_price_sos}, ${product.selling_price_etb})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        ${isSuperuser ? `
                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                onclick="confirmDelete(${product.id}, '${product.name.replace(/'/g, "\\'")}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
        `).join('');
    };

    // Currency conversion rates
    const usdToSosRate = parseFloat('{{ currency_settings.usd_to_sos_rate|default:"8000" }}') || 8000;
    const usdToEtbRate = parseFloat('{{ currency_settings.usd_to_etb_rate|default:"100" }}') || 100;

    // Flag to prevent circular updates
    let isUpdatingPrices = false;

    // Conversion helper functions
    function convertUSDToSOS(usd) {
        return (parseFloat(usd) * usdToSosRate).toFixed(2);
    }

    function convertUSDToETB(usd) {
        return (parseFloat(usd) * usdToEtbRate).toFixed(2);
    }

    function convertSOSToUSD(sos) {
        return (parseFloat(sos) / usdToSosRate).toFixed(2);
    }

    function convertETBToUSD(etb) {
        return (parseFloat(etb) / usdToEtbRate).toFixed(2);
    }

    // Set up auto-conversion event listeners
    function setupPriceConversion() {
        const usdInput = document.getElementById('editPriceUSD');
        const sosInput = document.getElementById('editPriceSOS');
        const etbInput = document.getElementById('editPriceETB');

        if (!usdInput || !sosInput || !etbInput) return;

        // USD input changed -> update SOS and ETB
        usdInput.addEventListener('input', function () {
            if (isUpdatingPrices) return;
            isUpdatingPrices = true;

            const usdValue = parseFloat(this.value) || 0;
            sosInput.value = convertUSDToSOS(usdValue);
            etbInput.value = convertUSDToETB(usdValue);

            isUpdatingPrices = false;
        });

        // SOS input changed -> update USD and ETB
        sosInput.addEventListener('input', function () {
            if (isUpdatingPrices) return;
            isUpdatingPrices = true;

            const sosValue = parseFloat(this.value) || 0;
            const usdValue = convertSOSToUSD(sosValue);
            usdInput.value = usdValue;
            etbInput.value = convertUSDToETB(usdValue);

            isUpdatingPrices = false;
        });

        // ETB input changed -> update USD and SOS
        etbInput.addEventListener('input', function () {
            if (isUpdatingPrices) return;
            isUpdatingPrices = true;

            const etbValue = parseFloat(this.value) || 0;
            const usdValue = convertETBToUSD(etbValue);
            usdInput.value = usdValue;
            sosInput.value = convertUSDToSOS(usdValue);

            isUpdatingPrices = false;
        });
    }

    // Initialize price conversion listeners when DOM is ready
    document.addEventListener('DOMContentLoaded', function () {
        setupPriceConversion();
    });

    // Edit functions
    window.openEditModal = function (productId, productName, purchasePrice, priceUSD, priceSOS, priceETB) {
        document.getElementById('editProductId').value = productId;
        document.getElementById('editProductName').value = productName;
        document.getElementById('editPurchasePrice').value = purchasePrice;
        document.getElementById('editPriceUSD').value = priceUSD;
        document.getElementById('editPriceSOS').value = priceSOS;
        document.getElementById('editPriceETB').value = priceETB;

        const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
        modal.show();

        // Ensure event listeners are set up
        setupPriceConversion();
    };

    window.submitEdit = function () {
        const productId = document.getElementById('editProductId').value;
        const formData = new FormData(document.getElementById('editProductForm'));

        const submitBtn = document.querySelector('#editProductModal .btn-primary');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        submitBtn.disabled = true;

        fetch(`/api/product/${productId}/update/`, {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (window.showToast) showToast(data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
                    if (window.loadAllProducts) loadAllProducts();
                } else {
                    if (window.showToast) showToast(data.error || 'Failed to update product', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (window.showToast) showToast('Error updating product', 'error');
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
    };

    // Delete functions
    window.confirmDelete = function (productId, productName) {
        document.getElementById('deleteProductId').value = productId;
        document.getElementById('deleteProductName').textContent = productName;

        const modal = new bootstrap.Modal(document.getElementById('deleteProductModal'));
        modal.show();
    };

    window.submitDelete = function () {
        const productId = document.getElementById('deleteProductId').value;

        const submitBtn = document.querySelector('#deleteProductModal .btn-danger');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
        submitBtn.disabled = true;

        fetch(`/api/product/${productId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (window.showToast) showToast(data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('deleteProductModal')).hide();
                    if (window.loadAllProducts) loadAllProducts();
                } else {
                    if (window.showToast) showToast(data.error || 'Failed to delete product', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (window.showToast) showToast('Error deleting product', 'error');
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
    };
}) ();
</script>